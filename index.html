<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <title id="pageTitle">เว็ป/แอปคำนวณต้นทุน</title> 

  <link rel="manifest" href="manifest.json"> 
  <link rel="icon" href="icon-192.png" sizes="192x192"> 
  <link rel="apple-touch-icon" sizes="180x180" href="icon-512.png"> 
  <meta name="apple-mobile-web-app-capable" content="yes"> 
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"> 
  <meta name="theme-color" content="#4CAF50"> 

  <style>
    body {font-family:'Segoe UI',sans-serif;margin:0;padding:20px;display:flex;justify-content:center;background:linear-gradient(to bottom right,#f0f4f8,#d9e2ec);color:#000;transition:background 0.4s,color 0.4s;}
    body.dark{background:linear-gradient(to bottom right,#1e1e1e,#2c2c2c);color:#fff;}
    .container{width:95%;max-width:720px;background:#fff;padding:25px 30px;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,0.12); position: relative;}
    body.dark .container{background:#2a2a2a;box-shadow:0 10px 30px rgba(0,0,0,0.6);}
    h2{text-align:center;margin-top:0;}
    .language-select{text-align:right;margin-bottom:15px;display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;}
    details{margin:15px 0;border-radius:12px;padding:12px;background:#f9fafc;box-shadow:0 2px 8px rgba(0,0,0,0.08);}
    body.dark details{background:#333;color:#fff;}
    details summary{font-weight:600;font-size:16px;cursor:pointer;outline:none;}
    .input-row{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;align-items:center;}
    .input-row input,.input-row select{flex:1;padding:10px 12px;border:1px solid #ccd6dd;border-radius:10px;font-size:14px;background:#fff;}
    body.dark .input-row input,body.dark .input-row select{background:#444;color:#fff;border-color:#666;}
    button{padding:10px 18px;margin:5px 5px 5px 0;cursor:pointer;border:none;border-radius:12px;background:#4CAF50;color:white;font-weight:600;font-size:15px;}
    button:hover{background:#45a049;}
    button.delete{background:#e74c3c;}
    button.delete:hover{background:#c0392b;}
    #result{margin-top:20px;padding:20px;border-radius:16px;background:#e8f5e9;border:1px solid #a5d6a7;font-weight:500;line-height:1.9;}
    body.dark #result{background:#3a3a3a;border:1px solid #666;color:#fff;}
    #versionPanel{position:fixed;bottom:10px;left:10px;padding:6px 10px;background:rgba(0,0,0,0.7);color:#fff;font-size:11px;border-radius:6px;z-index:9999;}

    .tutorial-btn {
      position: absolute; top: 15px; left: 15px; width: 42px; height: 42px; border-radius: 50%;
      background: #4CAF50; color: white; font-size: 22px; font-weight: bold; border: none;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4); z-index: 100; animation: tutorial-pulse 2s infinite;
    }

    @keyframes tutorial-pulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
      70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
    }

    #tutorialOverlay {
      display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); 
      z-index:10001; align-items:center; justify-content:center; padding:20px;
    }
    #tutorialBox { background:#fff; width:100%; max-width:600px; border-radius:20px; overflow:hidden; position:relative; }
    body.dark #tutorialBox { background:#2a2a2a; color: white; }
    .close-modal { position:absolute; right:15px; top:10px; cursor:pointer; font-size:24px; z-index:10;}
    .video-container { position:relative; padding-bottom:56.25%; height:0; }
    .video-container video { position:absolute; top:0; left:0; width:100%; height:100%; border:none; background: #000; }
  </style>
</head>

<body>

  <div class="container"> 
    <button class="tutorial-btn" onclick="openTutorial()">?</button>

    <div class="language-select"> 
      <select id="langSelect" onchange="switchLang()"> 
        <option value="th">ไทย</option> 
        <option value="en">English</option> 
      </select> 
      <button id="themeBtn" onclick="toggleDarkMode()">ตามระบบ</button> 
    </div> 

    <h2 id="title">เว็ป/แอปคำนวณต้นทุน</h2> 

    <details open> 
      <summary id="labelMaterial">วัตถุดิบ</summary> 
      <div id="materials"></div> 
      <button onclick="addMaterial()" id="addBtn">+ เพิ่มวัตถุดิบ</button> 
    </details> 

    <details> 
      <summary id="labelLabor">ค่าแรง &amp; ค่าใช้จ่าย</summary> 
      <div class="input-row"> 
        <input type="number" id="workers" placeholder="จำนวนคน" oninput="calculate()"> 
        <input type="number" id="wage" placeholder="ค่าแรงต่อคน" oninput="calculate()"> 
      </div> 
      <div class="input-row"> 
        <input type="number" id="water" placeholder="ค่าน้ำ" oninput="calculate()"> 
        <input type="number" id="electricity" placeholder="ค่าไฟ" oninput="calculate()"> 
      </div> 
    </details> 

    <div style="margin-top:15px;"> 
      <button onclick="calculate()" id="calcBtn">คำนวณ</button> 
      <button onclick="resetAll()" id="resetBtn">รีเซ็ต</button> 
    </div> 

    <div id="result"></div> 
  </div> 

  <div id="versionPanel">v2.2.1</div> 

  <div class="video-container">
  <video id="tutorialVideo" controls playsinline preload="metadata" poster="images/tutorial-placeholder.jpg">
    <source src="videos/tutorial.mp4" type="video/mp4">
    <source src="videos/copy_D1A6D274-8E5F-4A80-B1B5-B1C85BBC90D2.mov" type="video/quicktime">
    
    <p>Your browser does not support the video tag. 
       <a href="videos/tutorial.mp4" style="color: #4CAF50;">Download video instead</a>.
    </p>
  </video>
</div>
  
  <script>
    let materialCount = 0;

    const texts = {
      th: {
        title: "เว็ป/แอปคำนวณต้นทุน", materials: "วัตถุดิบ", laborSection: "ค่าแรง & ค่าใช้จ่าย",
        workers: "จำนวนคน", wage: "ค่าแรง/คน", water: "ค่าน้ำ", electricity: "ค่าไฟ",
        matName: "ชื่อวัตถุดิบ", matQty: "จำนวน", matCost: "ราคาต่อหน่วย", matProfit: "กำไร/หน่วย",
        addMaterial: "+ เพิ่มวัตถุดิบ", deleteBtn: "ลบ", labor: "ค่าแรงรวม", other: "ค่าน้ำ + ค่าไฟ",
        material: "วัตถุดิบรวม", total: "ต้นทุนรวม", profitText: "กำไรรวม", sale: "ราคาขายรวม",
        calc: "คำนวณ", reset: "รีเซ็ต", darkMode: "โหมดมืด", lightMode: "โหมดสว่าง", autoMode: "ตามระบบ",
        symbol: "฿", symbolBefore: false, empty: "กรุณาใส่ข้อมูลเพื่อคำนวณ"
      },
      en: {
        title: "Cost Calculator", materials: "Materials", laborSection: "Labor & Expenses",
        workers: "Workers", wage: "Wage/person", water: "Water bill", electricity: "Electricity bill",
        matName: "Material name", matQty: "Qty", matCost: "Cost/unit", matProfit: "Profit/unit",
        addMaterial: "+ Add material", deleteBtn: "Delete", labor: "Labor cost", other: "Water + Elec",
        material: "Materials", total: "Total cost", profitText: "Profit", sale: "Selling price",
        calc: "Calculate", reset: "Reset", darkMode: "Dark Mode", lightMode: "Light Mode", autoMode: "Auto",
        symbol: "$", symbolBefore: true, empty: "Please enter data"
      }
    };

    function formatMoney(amount) {
      const lang = document.getElementById("langSelect").value;
      const t = texts[lang];
      const num = Number(amount).toLocaleString("en-US", {minimumFractionDigits: 0, maximumFractionDigits: 2});
      return t.symbolBefore ? `${t.symbol}${num}` : `${num} ${t.symbol}`;
    }

    function switchLang() {
      const lang = document.getElementById("langSelect").value;
      const t = texts[lang];
      localStorage.setItem("lang", lang);
      document.getElementById("title").textContent = t.title;
      document.getElementById("pageTitle").textContent = t.title;
      document.getElementById("labelMaterial").textContent = t.materials;
      document.getElementById("labelLabor").textContent = t.laborSection;
      document.getElementById("addBtn").textContent = t.addMaterial;
      document.getElementById("calcBtn").textContent = t.calc;
      document.getElementById("resetBtn").textContent = t.reset;
      document.getElementById("workers").placeholder = t.workers;
      document.getElementById("wage").placeholder = t.wage;
      document.getElementById("water").placeholder = t.water;
      document.getElementById("electricity").placeholder = t.electricity;
      document.querySelectorAll("#materials .input-row").forEach(row => {
        row.children[0].placeholder = t.matName;
        row.children[1].placeholder = t.matQty;
        row.children[2].placeholder = t.matCost;
        row.children[3].placeholder = t.matProfit;
        if (row.children[4]) row.children[4].textContent = t.deleteBtn;
      });
      updateThemeButton();
      calculate();
    }

    function toggleDarkMode() {
      const saved = localStorage.getItem("theme");
      if (saved === "dark") localStorage.setItem("theme", "light");
      else if (saved === "light") localStorage.removeItem("theme");
      else localStorage.setItem("theme", "dark");
      updateThemeButton();
    }

    function updateThemeButton() {
      const lang = document.getElementById("langSelect").value;
      const t = texts[lang];
      const saved = localStorage.getItem("theme");
      if (saved === "dark") {
        document.body.classList.add("dark");
        document.getElementById("themeBtn").textContent = t.lightMode;
      } else if (saved === "light") {
        document.body.classList.remove("dark");
        document.getElementById("themeBtn").textContent = t.darkMode;
      } else {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (prefersDark) document.body.classList.add('dark');
        else document.body.classList.remove('dark');
        document.getElementById("themeBtn").textContent = t.autoMode;
      }
    }

    function addMaterial(name="", qty="", cost="", profit="") {
      materialCount++;
      const t = texts[document.getElementById("langSelect").value];
      const div = document.createElement("div");
      div.className = "input-row";
      div.id = "material-" + materialCount;
      div.innerHTML = `
        <input type="text" placeholder="${t.matName}" value="${name}" style="flex:2" oninput="saveData()">
        <input type="text" placeholder="${t.matQty}" value="${qty}" oninput="calculate()">
        <input type="number" placeholder="${t.matCost}" value="${cost}" oninput="calculate()">
        <input type="number" placeholder="${t.matProfit}" value="${profit}" oninput="calculate()">
        <button class="delete" onclick="deleteMaterial(${materialCount})">${t.deleteBtn}</button>
      `;
      document.getElementById("materials").appendChild(div);
      saveData();
    }

    function deleteMaterial(id) {
      document.getElementById("material-" + id)?.remove();
      saveData();
      calculate();
    }

    function calculate() {
      const lang = document.getElementById("langSelect").value;
      const t = texts[lang];
      const workers = parseFloat(document.getElementById("workers").value) || 0;
      const wage = parseFloat(document.getElementById("wage").value) || 0;
      const water = parseFloat(document.getElementById("water").value) || 0;
      const electricity = parseFloat(document.getElementById("electricity").value) || 0;

      let materialCostTotal = 0, profitTotal = 0, hasData = false;
      document.querySelectorAll("#materials .input-row").forEach(row => {
        const qtyVal = parseFloat(row.children[1].value) || (row.children[1].value !== "" ? 1 : 0);
        const costVal = parseFloat(row.children[2].value) || 0;
        const profitVal = parseFloat(row.children[3].value) || 0;
        
        if (qtyVal > 0 || costVal > 0 || profitVal > 0) hasData = true;
        
        materialCostTotal += qtyVal * costVal;
        profitTotal += qtyVal * profitVal;
      });

      const laborCost = workers * wage;
      const otherCost = water + electricity;
      const totalCost = laborCost + otherCost + materialCostTotal;
      const sellingPrice = totalCost + profitTotal;

      if (laborCost > 0 || otherCost > 0) hasData = true;

      let lines = [];
      if (laborCost > 0) lines.push(`${t.labor}: <strong>${formatMoney(laborCost)}</strong>`);
      if (otherCost > 0) lines.push(`${t.other}: <strong>${formatMoney(otherCost)}</strong>`);
      if (materialCostTotal > 0) lines.push(`${t.material}: <strong>${formatMoney(materialCostTotal)}</strong>`);
      if (totalCost > 0) lines.push(`${t.total}: <strong>${formatMoney(totalCost)}</strong>`);
      if (profitTotal > 0) lines.push(`<br>${t.profitText}: <strong>${formatMoney(profitTotal)}</strong>`);

      document.getElementById("result").innerHTML = hasData
        ? lines.join("<br>") + `<br><br><strong style="font-size:1.4em;color:#4CAF50;">${t.sale}: ${formatMoney(sellingPrice)}</strong>`
        : `<span style="color:#999;">${t.empty}</span>`;
      
      saveData();
    }

    function saveData() {
      const data = {
        lang: document.getElementById("langSelect").value,
        workers: document.getElementById("workers").value,
        wage: document.getElementById("wage").value,
        water: document.getElementById("water").value,
        electricity: document.getElementById("electricity").value,
        materials: []
      };
      document.querySelectorAll("#materials .input-row").forEach(row => {
        data.materials.push({
          name: row.children[0].value, 
          qty: row.children[1].value, 
          cost: row.children[2].value, 
          profit: row.children[3].value
        });
      });
      localStorage.setItem("calcData", JSON.stringify(data));
    }

    function loadData() {
      const saved = localStorage.getItem("calcData");
      if (!saved) { addMaterial(); return; }
      const data = JSON.parse(saved);
      document.getElementById("langSelect").value = data.lang || "th";
      switchLang();
      document.getElementById("workers").value = data.workers || "";
      document.getElementById("wage").value = data.wage || "";
      document.getElementById("water").value = data.water || "";
      document.getElementById("electricity").value = data.electricity || "";
      document.getElementById("materials").innerHTML = "";
      (data.materials || []).forEach(m => addMaterial(m.name, m.qty, m.cost, m.profit));
      if (document.querySelectorAll("#materials .input-row").length === 0) addMaterial();
    }

    function resetAll() {
      if (confirm("ลบข้อมูลทั้งหมดหรือไม่? / Clear all data?")) {
        localStorage.removeItem("calcData");
        location.reload();
      }
    }

    function openTutorial() {
      document.getElementById("tutorialOverlay").style.display = "flex";
    }

    function closeTutorial() {
      document.getElementById("tutorialOverlay").style.display = "none";
      const video = document.getElementById("tutorialVideo");
      video.pause();
    }

    function handleOverlayClick(e) {
      if (e.target.id === "tutorialOverlay") {
        closeTutorial();
      }
    }

    window.onload = () => { loadData(); updateThemeButton(); calculate(); };
  </script>
</body>
</html>
